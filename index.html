<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>検定サイト</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Yu Gothic", sans-serif; line-height:1.6; margin:0; }
    .container { max-width: 960px; margin: 0 auto; padding: 16px; }
    .hidden { display: none !important; }
    .grid { display: grid; gap: 12px; }
    .grid.cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    .card { border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; background:#fff; box-shadow: 0 1px 2px rgba(0,0,0,.04); }
    .btn { padding: 10px 14px; border-radius: 10px; border: 1px solid #e5e7eb; background: #111827; color: #fff; cursor: pointer; }
    .btn:disabled { opacity: .5; cursor: not-allowed; }
    .muted { color: #6b7280; font-size: 13px; }
    .choices { display: grid; gap: 8px; margin-top: 8px; }
    .choice { padding: 10px 12px; border: 1px solid #e5e7eb; border-radius: 10px; cursor: pointer; background:#fafafa; }
    .choice:hover { background:#f3f4f6; }
    header { padding: 12px 0; border-bottom:1px solid #eee; background:#fafafa; }
    header .row { display:flex; justify-content:space-between; align-items:center; gap:12px; }
  
    .grade.active { outline: 2px solid #2563eb; box-shadow: 0 0 0 3px rgba(37,99,235,0.15) inset; }
    .choice.selected { border-color:#2563eb; background:#eef2ff; }
    
  </style>

<style>
  .grade.active{outline:3px solid #2563eb;border-color:#2563eb;box-shadow:0 0 0 3px rgba(37,99,235,0.12) inset;}
  .hud{display:flex;gap:10px;align-items:center;margin-bottom:8px;flex-wrap:wrap;}
  .badge{display:inline-block;padding:6px 10px;border-radius:9999px;border:1px solid #e5e7eb;background:#f9fafb;font-size:12px;color:#111827;}
</style>


<style>
  /* Clickable areas visible outline */
  .grade{ border:2px solid #e5e7eb; }
  .grade:hover{ outline:3px solid #93c5fd; border-color:#93c5fd; }
  .grade.active{ outline:3px solid #2563eb; border-color:#2563eb; box-shadow:0 0 0 3px rgba(37,99,235,0.12) inset; }
</style>

</head>
<body>
  <header>
    <div class="container row">
      <div><strong>検定サイト</strong> <span class="muted">（総問題数: <span id="total-count">0</span>）</span></div>
      <div class="muted">CSV は index.html と同じ階層に置いてください（questions.csv / question.csv）</div>
    </div>
  </header>

  <main class="container">
    <section class="card" id="menu">
      <h2>級を選んでスタート</h2>
      <p class="small muted">「1級（最難）〜4級（入門）」。選んだ級の問題だけが出題されます。</p>
      <div class="grid4" id="grade-list">
        <div class="grade" data-grade="1">
          <span class="badge">1級</span>
          <h3>エキスパート</h3>
          <div class="small muted">応用・難問中心</div>
        </div>
        <div class="grade" data-grade="2">
          <span class="badge">2級</span>
          <h3>上級</h3>
          <div class="small muted">標準＋やや難</div>
        </div>
        <div class="grade" data-grade="3">
          <span class="badge">3級</span>
          <h3>中級</h3>
          <div class="small muted">基礎の確認</div>
        </div>
        <div class="grade" data-grade="4">
          <span class="badge">4級</span>
          <h3>入門</h3>
          <div class="small muted">初めての方に</div>
        </div>
      </div>
      <div class="row" style="margin-top:16px">
  <button class="btn" id="btn-start">この級で受験を開始</button>
<!-- ▼ 追加：CSVインポート -->
  <input id="file-questions" type="file" accept=".csv,text/csv" style="display:none">
  <button class="btn ghost" id="btn-import" title="Excelから書き出したCSVを読み込む">問題CSVを読み込む</button>
  </div>
    <p class="muted" id="selected-grade-label" style="margin-top:8px;"></p>
</section>

    <section id="intro" class="card hidden">
      <div class="muted">説明：各設問に回答してください（全問出題）。</div>
    </section>

    <section id="quiz" class="card hidden">

      <div style="display:flex;justify-content:flex-end;gap:8px;margin-bottom:8px;">
        <button class="btn" id="btn-back-menu" type="button">メニューに戻る</button>
      </div>
      <div id="qtext"><strong>Q.</strong> …</div>
      <div class="choices" id="choices"></div>
      <div style="margin-top:12px; display:flex; gap:8px; align-items:center;">
        <button class="btn" id="btn-next" type="button">次へ</button>
        <span class="muted" id="progress">0 / 0</span>
      </div>
    </section>

    <section id="summary" class="card hidden">
      <h3>結果</h3>
      <div id="score"></div>
      <div style="margin-top:12px;">
        <button class="btn" id="btn-retry" type="button">メニューに戻る</button>
      </div>
    </section>
  </main>

<!-- ==== Core State ==== -->
<script>
window.questions = window.questions || [];
let dataReady = false;
let selectedGrade = 0;
let bank = [];
let order = [];
let current = 0;
let answers = {};
let choiceOrder = {};
let startedAt = null;
let countdownId = null;
</script>

<!-- ==== CSV Parsers ==== -->
<script>
(function(){
  if (window._csvParsersReady) return; window._csvParsersReady = true;

  window.parseCSV = function(str){
    const out=[]; let row=[], cur='', q=false;
    for(let i=0;i<str.length;i++){
      const ch=str[i], nx=str[i+1];
      if(q){
        if(ch=='"' && nx=='"'){ cur+='"'; i++; }
        else if(ch=='"'){ q=false; }
        else { cur+=ch; }
      }else{
        if(ch=='"'){ q=true; }
        else if(ch==','){ row.push(cur); cur=''; }
        else if(ch=='\n'){ row.push(cur); out.push(row); row=[]; cur=''; }
        else if(ch=='\r'){ }
        else { cur+=ch; }
      }
    }
    row.push(cur); out.push(row);
    return out.filter(r=>r.some(c=>String(c).trim()!==''));
  };

  window.rowsToQuestions = function(rows){
    if(!rows.length) return [];
    const header = rows[0].map(h=>String(h||'').trim());
    const norm = s => String(s||'').toLowerCase().replace(/\s+/g,'').replace(/　/g,'');
    const findAny = cands => header.findIndex(h => cands.some(k => norm(h).includes(k)));
    const col = {
      id:     findAny(['id','識別','番号']),
      grade:  findAny(['grade','級','レベル','level','等級']),
      q:      findAny(['q','question','問題','設問','問']),
      c1:     findAny(['choice1','選択肢1','こたえ1','解答1','a)']),
      c2:     findAny(['choice2','選択肢2','こたえ2','解答2','b)']),
      c3:     findAny(['choice3','選択肢3','こたえ3','解答3','c)']),
      c4:     findAny(['choice4','選択肢4','こたえ4','解答4','d)']),
      c5:     findAny(['choice5','選択肢5','こたえ5','解答5','e)']),
      c6:     findAny(['choice6','選択肢6','こたえ6','解答6','f)']),
      answer: findAny(['answer','正解','解答','ans']),
      exp:    findAny(['exp','解説','説明','comment']),
      tags:   findAny(['tags','タグ','分類','カテゴリ']),
      img:    findAny(['img','画像','image']),
      images: findAny(['images','画像一覧'])
    };
    const hasHeader = col.q !== -1 && (col.c1 !== -1 || col.c2 !== -1);
    const start = hasHeader ? 1 : 0;
    const toHalf = s => String(s||'').replace(/[０-９]/g, d => String.fromCharCode(d.charCodeAt(0)-0xFEE0));
    const list = [];
    for(let r=start; r<rows.length; r++){
      const row = rows[r];
      const get = i => (i>=0 && i<row.length) ? String(row[i]||'').trim() : '';
      const q = get(col.q); if(!q) continue;
      const choices = [get(col.c1),get(col.c2),get(col.c3),get(col.c4),get(col.c5),get(col.c6)].filter(Boolean);
      if(choices.length<2) continue;
      let ansRaw = toHalf(get(col.answer)||'1'); const ansDig = ansRaw.match(/\d+/);
      const answer = ansDig ? Math.max(0, parseInt(ansDig[0],10)-1) : 0;
      let gRaw = toHalf(get(col.grade)||'4'); const gDig = gRaw.match(/[1-4]/);
      const grade = gDig ? parseInt(gDig[0],10) : 4;
      const exp = get(col.exp);
      const tags = (get(col.tags)||'').replace('／','/').replace('|','/').split('/').map(s=>s.trim()).filter(Boolean);
      const imgsField = get(col.images);
      const imgField = get(col.img);
      const images = imgsField ? imgsField.split('|').map(s=>s.trim()).filter(Boolean) : (imgField ? [imgField] : []);
      list.push({ id: get(col.id)||`q${r}`, grade, q, choices, answer, exp, tags, images });
    }
    return list;
  };
})();
</script>

<!-- ==== Autoload (UTF-8/SJIS) ==== -->
<script>
(function(){
  if (window._csvAutoloadInstalled) return; window._csvAutoloadInstalled = true;
  function stripBOM(s){ return s && s.charCodeAt(0)===0xFEFF ? s.slice(1) : s; }
  function decodeWithFallback(buf){
    try{ const u = new TextDecoder('utf-8',{fatal:false}).decode(buf); if(u && u.indexOf('\uFFFD')===-1) return u; }catch(e){}
    try{ return new TextDecoder('shift_jis',{fatal:false}).decode(buf); }catch(e){}
    try{ return new TextDecoder('utf-8').decode(buf); }catch(e){ return ''; }
  }
  async function fetchCsvTry(files){
    for(const f of files){
      try{
        const res = await fetch(f + '?v=' + Date.now(), {cache:'no-store'});
        if(res.ok){
          const buf = await res.arrayBuffer();
          const txt = decodeWithFallback(buf);
          if (txt && txt.trim()) return {name:f, text:txt};
        }
      }catch(e){ console.warn('fetch failed', f, e); }
    }
    return null;
  }
  async function autoload(){
    const got = await fetchCsvTry(['questions.csv','question.csv']);
    if(!got){ console.warn('[autoload] CSV not found'); return; }
    let csv = stripBOM(got.text).replace(/\r\n/g,'\n').replace(/\r/g,'\n');
    if (typeof parseCSV !== 'function' || typeof rowsToQuestions !== 'function'){ console.error('[autoload] parsers missing'); return; }
    try{
      const rows = parseCSV(csv);
      const imported = rowsToQuestions(rows);
      if(Array.isArray(imported) && imported.length){
        window.questions = Array.isArray(window.questions)?window.questions:[];
        window.questions.splice(0, window.questions.length, ...imported);
        dataReady = true;
        const el = document.getElementById('total-count'); if(el) el.textContent = String(imported.length);
        recountByGrade();
        console.log(`[autoload] CSV loaded (${got.name}): ${imported.length} questions`);
      }else{
        console.warn('[autoload] parsed 0 questions');
      }
    }catch(e){ console.error('[autoload] parse error', e); }
  }
  if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', autoload); } else { autoload(); }
})();
</script>

<!-- ==== Helpers / UI ==== -->
<script>
function recountByGrade(){
  const c = {1:0,2:0,3:0,4:0};
  (Array.isArray(window.questions)?window.questions:[]).forEach(q=>{
    const g = Number(q && q.grade);
    if(g>=1 && g<=4) c[g]++;
  });
  document.getElementById('count-g1').textContent = c[1];
  document.getElementById('count-g2').textContent = c[2];
  document.getElementById('count-g3').textContent = c[3];
  document.getElementById('count-g4').textContent = c[4];
  window.countsByGrade = c;
}

document.addEventListener('DOMContentLoaded', function(){
  // grade select numeric
  document.querySelectorAll('.grade').forEach(function(el){
    el.addEventListener('click', function(){
      selectedGrade = Number(el.dataset.grade||0);
      document.querySelectorAll('.grade').forEach(x=>x.classList.remove('active'));
      el.classList.add('active');
      // enable start
      if(startBtn){ startBtn.disabled = false; startBtn.removeAttribute('disabled'); }
      // label
      var lab = document.getElementById('selected-grade-label');
      if(lab){ lab.textContent = '選択中: ' + selectedGrade + '級'; }
    });
  });

  // start button
  var startBtn = document.getElementById('btn-start');
  if(startBtn){
    startBtn.disabled = false;
    startBtn.removeAttribute('disabled');
    startBtn.addEventListener('click', function(e){
      e.preventDefault();
      start();
    });
  }

  // next
  document.getElementById('btn-next').addEventListener('click', function(){
    if(current < order.length-1){
      current++;
      renderCurrent();
    }else{
      finish();
    }
  });

  // summary → menu
  document.getElementById('btn-retry').addEventListener('click', function(){
    backToMenu(true);
  });

  // back to menu in quiz
  document.getElementById('btn-back-menu').addEventListener('click', function(){
    backToMenu(false);
  });
});
</script>

<!-- ==== Core Quiz Logic ==== -->
<script>
function prepareBank(grade){
  const g = Number(grade||0);
  const qs = Array.isArray(window.questions) ? window.questions : [];
  bank = qs.filter(q => Number(q && q.grade) === g);
  order = bank.map((_,i)=>i);
  current = 0;
  answers = {};
  choiceOrder = {};
}

function start(){
  // guards
  if(!dataReady || !Array.isArray(window.questions) || window.questions.length===0){
    alert('問題データを読み込み中です。数秒後にもう一度お試しください。');
    return;
  }
  if(!selectedGrade){
    alert('級を選んでください。');
    return;
  }

  // build pool
  prepareBank(selectedGrade);
  if(!bank || !bank.length){
    const ok = confirm(`${selectedGrade}級の問題が0件です。全問題から出題してもよろしいですか？`);
    if(!ok) return;
    bank = window.questions.slice();
    order = bank.map((_,i)=>i);
  }

  // show quiz
  document.getElementById('menu').classList.add('hidden');
  document.getElementById('intro').classList.remove('hidden');
  document.getElementById('quiz').classList.remove('hidden');
  renderCurrent();
  var nb=document.getElementById('btn-next'); if(nb){ nb.disabled = true; }
}

function renderCurrent(){
  const qi = order[current];
  if(qi==null){ current = 0; renderCurrent(); return; }
  const q = bank[qi];
  document.getElementById('qtext').innerHTML = `<strong>Q.</strong> ${q.q}`;
  const box = document.getElementById('choices');
  box.innerHTML = '';
  const nextBtn = document.getElementById('btn-next');
  if(nextBtn){ nextBtn.disabled = true; }

  const choices = q.choices.slice(); // 並び固定
  const saved = answers.hasOwnProperty(qi) ? answers[qi] : null;

  choices.forEach((c,idx)=>{
    const b = document.createElement('button');
    b.className = 'choice' + (saved===idx ? ' selected' : '');
    b.type = 'button';
    b.textContent = `${idx+1}. ${c}`;
    b.addEventListener('click', ()=>{
      // 選択状態の更新
      answers[qi] = idx;
      // 全てのchoiceからselectedを外して、クリックしたものに付与
      box.querySelectorAll('.choice').forEach(x=>x.classList.remove('selected'));
      b.classList.add('selected');
      // 次へ有効化
      if(nextBtn){ nextBtn.disabled = false; }
    });
    box.appendChild(b);
  });

  // 既に回答済みなら Next を有効化
  if(saved !== null && nextBtn){ nextBtn.disabled = false; }

  document.getElementById('progress').textContent = `${current+1} / ${order.length}`;
}

function finish(){
  let correct = 0;
  order.forEach((qi)=>{
    const q = bank[qi];
    if(answers[qi] === q.answer) correct++;
  });
  const score = `${correct} / ${order.length}`;
  document.getElementById('score').textContent = `スコア：${score}`;

  document.getElementById('quiz').classList.add('hidden');
  document.getElementById('summary').classList.remove('hidden');
}

function backToMenu(skipConfirm){
  if(!skipConfirm){
    if(!confirm('試験を中断してメニューに戻ります。進捗は失われます。よろしいですか？')) return;
  }
  // reset
  if (countdownId){ clearInterval(countdownId); countdownId = null; }
  answers = {};
  current = 0;
  choiceOrder = {};
  startedAt = null;

  // show menu
  document.getElementById('menu').classList.remove('hidden');
  document.getElementById('intro').classList.add('hidden');
  document.getElementById('quiz').classList.add('hidden');
  document.getElementById('summary').classList.add('hidden');
  recountByGrade();
}
</script>


<script>
document.addEventListener('DOMContentLoaded', function(){
  // グローバル選択級
  window.selectedGrade = window.selectedGrade || 0;

  // 級カードの選択
  document.querySelectorAll('.grade').forEach(function(el){
    el.addEventListener('click', function(){
      window.selectedGrade = Number(el.dataset.grade||0);
      document.querySelectorAll('.grade').forEach(x=>x.classList.remove('active'));
      el.classList.add('active');
      var s = document.getElementById('btn-start');
      if(s){ s.disabled = false; s.removeAttribute('disabled'); }
      var lab = document.getElementById('selected-grade-label');
      if(lab){ lab.textContent = '選択中: ' + window.selectedGrade + '級'; }
    });
  });

  // 開始ボタン
  var sbtn = document.getElementById('btn-start');
  if(sbtn && !sbtn._bound){
    sbtn._bound = true;
    sbtn.addEventListener('click', function(e){
      e.preventDefault();
      if(typeof window.start === 'function'){ window.start(); }
    });
  }
});
</script>


<script>
document.addEventListener('DOMContentLoaded', function(){
  // すでに他のスクリプトが設定している可能性があるが、二重設定を避けつつ補強
  document.querySelectorAll('.grade').forEach(function(el){
    if (el._activePatchBound) return;
    el._activePatchBound = true;
    el.addEventListener('click', function(){
      document.querySelectorAll('.grade').forEach(x => x.classList.remove('active'));
      el.classList.add('active');
    });
  });
});
</script>


<script>
window.TIME_LIMIT_MINUTES = window.TIME_LIMIT_MINUTES || {1: 30, 2: 25, 3: 20, 4: 15}; // 級ごとの制限時間（分）
</script>


<script>
(function(){
  if (window._hudPatchedV2) return; window._hudPatchedV2 = true;

  function pad(n){ return (n<10?'0':'') + n; }
  function fmt(secs){
    secs = Math.max(0, secs|0);
    const m = Math.floor(secs/60), s = secs%60;
    return pad(m) + ':' + pad(s);
  }

  function computeRemainingSeconds(){
    if (!window._deadlineTs) return 0;
    return Math.max(0, Math.floor((window._deadlineTs - Date.now())/1000));
  }

  function updateHudCountdown(){
    try{
      var timeEl = document.getElementById('hud-time');
      if(!timeEl) return;

      // countdown time (remaining)
      var secs = computeRemainingSeconds();
      if(timeEl) timeEl.textContent = '残り時間: ' + fmt(secs);

      // auto-finish when time is up
      if (secs <= 0){
        try { if (window._hudTimer) { clearInterval(window._hudTimer); window._hudTimer = null; } } catch(e){}
        if (typeof window.finish === 'function') window.finish();
      }
    }catch(e){ /* noop */ }
  }

  function startCountdown(){
    try{
      // decide limit by selectedGrade (fallback 20 min)
      var g = Number(window.selectedGrade || 0);
      var map = (window.TIME_LIMIT_MINUTES || {});
      var limitMin = Number(map[g] || 20);
      window._deadlineTs = Date.now() + limitMin*60*1000;
      if (window._hudTimer) clearInterval(window._hudTimer);
      window._hudTimer = setInterval(updateHudCountdown, 1000);
      updateHudCountdown();
    }catch(e){}
  }
  function stopCountdown(){
    try{ if(window._hudTimer){ clearInterval(window._hudTimer); window._hudTimer = null; } }catch(e){}
    window._deadlineTs = null;
  }

  document.addEventListener('DOMContentLoaded', function(){
    // Ensure HUD labels are present
    if(!document.getElementById('hud-time') || !document.getElementById('hud-remaining')){
      var quiz = document.getElementById('quiz');
      if(quiz){
        var hud = document.createElement('div');
        hud.className = 'hud';
        hud.innerHTML = '<span id="hud-time" class="badge">残り時間: 00:00</span>';
        quiz.insertBefore(hud, quiz.firstChild);
      }
    }

    // wrap start() to begin countdown
    if (typeof window.start === 'function' && !window.start._hudV2Wrapped){
      var _origStart = window.start;
      window.start = function(){
        var r = _origStart.apply(this, arguments);
        startCountdown();
        return r;
      };
      window.start._hudV2Wrapped = true;
    }

    // wrap renderCurrent() to update remaining
    if (typeof window.renderCurrent === 'function' && !window.renderCurrent._hudV2Wrapped){
      var _origRender = window.renderCurrent;
      window.renderCurrent = function(){
        var r = _origRender.apply(this, arguments);
        updateHudCountdown();
        return r;
      };
      window.renderCurrent._hudV2Wrapped = true;
    }

    // wrap finish() to stop countdown
    if (typeof window.finish === 'function' && !window.finish._hudV2Wrapped){
      var _origFinish = window.finish;
      window.finish = function(){
        stopCountdown();
        return _origFinish.apply(this, arguments);
      };
      window.finish._hudV2Wrapped = true;
    }

    // wrap backToMenu() to stop countdown
    if (typeof window.backToMenu === 'function' && !window.backToMenu._hudV2Wrapped){
      var _origBack = window.backToMenu;
      window.backToMenu = function(){
        stopCountdown();
        return _origBack.apply(this, arguments);
      };
      window.backToMenu._hudV2Wrapped = true;
    }
  });
})();
</script>

</body>
</html>
