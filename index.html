<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>検定サイト</title>
  <style>
    :root{--bg:#f8fafc;--fg:#0f172a;--muted:#64748b;--card:#ffffff;--line:#e5e7eb;--brand:#2563eb}
    body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .container{max-width:960px;margin:0 auto;padding:20px}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    h1{font-size:20px;margin:0}
    .card{border:1px solid var(--line);border-radius:12px;background:var(--card);padding:16px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .btn{padding:10px 14px;border-radius:10px;border:1px solid var(--line);background:#111827;color:#fff;cursor:pointer}
    .btn.secondary{background:#fff;color:#111827}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .muted{color:var(--muted);font-size:13px}
    .grid{display:grid;gap:12px}
    .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    #grade-list .grade{display:flex;flex-direction:column;gap:6px;padding:14px;border:2px solid var(--line);border-radius:10px;background:#fff;text-align:left;cursor:pointer}
    #grade-list .grade:hover{outline:3px solid #93c5fd;border-color:#93c5fd}
    #grade-list .grade.active{outline:3px solid var(--brand);border-color:var(--brand);box-shadow:0 0 0 3px rgba(37,99,235,.12) inset}
    #menu.hidden,#intro.hidden,#quiz.hidden,#summary.hidden{display:none}
    #choices{display:grid;gap:8px}
    .choice{padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;cursor:pointer}
    .choice.selected{border-color:var(--brand);background:#eef2ff}
    .hud{display:flex;gap:10px;align-items:center;margin-bottom:8px;flex-wrap:wrap}
    .badge{display:inline-block;padding:6px 10px;border-radius:9999px;border:1px solid var(--line);background:#f9fafb;font-size:12px;color:#111827}
  </style>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 16 16%22><text y=%2214%22 font-size=%2214%22>✅</text></svg>">
</head>
<body>
  <header class="card">
    <div class="container row">
      <h1>検定サイト</h1>
      <span id="csv-status" class="badge">CSV: 読み込み中…</span>
    </div>
  </header>

  <main class="container">
    <!-- menu -->
    <section id="menu" class="card">
      <h2>級を選んでください</h2>
      <div id="grade-list" class="grid cols-2">
        <button class="card grade" data-grade="1" type="button">
          <div><strong>１級</strong></div>
          <div class="muted">問題数: <span id="count-g1">0</span></div>
        </button>
        <button class="card grade" data-grade="2" type="button">
          <div><strong>２級</strong></div>
          <div class="muted">問題数: <span id="count-g2">0</span></div>
        </button>
        <button class="card grade" data-grade="3" type="button">
          <div><strong>３級</strong></div>
          <div class="muted">問題数: <span id="count-g3">0</span></div>
        </button>
        <button class="card grade" data-grade="4" type="button">
          <div><strong>４級</strong></div>
          <div class="muted">問題数: <span id="count-g4">0</span></div>
        </button>
      </div>
      <div style="margin-top:12px;display:flex;gap:12px;align-items:center;">
        <button id="btn-start" class="btn" type="button">この級で受験を開始</button>
        <span class="muted">CSV 自動読み込み完了後に開始できます</span>
        <span class="muted" id="selected-grade-label" style="margin-left:12px;"></span>
      </div>
    </section>

    <!-- intro -->
    <section id="intro" class="card hidden">
      <div id="hud" class="hud">
        <span id="hud-time" class="badge">残り時間: 00:00</span>
      </div>
      <p class="muted">問題は1問ずつ表示されます。選択肢をクリックして回答し、次へお進みください。</p>
    </section>

    <!-- 問題表示セクション -->
    <section id="quiz" class="card hidden">
      <div id="hud2" class="hud">
        <span id="hud-time-quiz" class="badge">残り時間: 00:00</span>
        <span id="progress" class="muted"></span>
      </div>
      <div id="qtext" style="margin-bottom:8px;"></div>
      <div id="choices"></div>
      <div class="row" style="margin-top:12px;">
        <button id="btn-prev" class="btn secondary" type="button" disabled>前の問題へ</button>
        <button id="btn-next" class="btn" type="button">次へ</button>
        <button id="btn-back-menu" class="btn secondary" type="button">メニューへ戻る</button>
      </div>
    </section>

    <!-- summary -->
    <section id="summary" class="card hidden">
      <h3>結果</h3>
      <p id="score" class="muted"></p>
      <div class="row">
        <button id="btn-to-menu" class="btn secondary" type="button">メニューに戻る</button>
      </div>
    </section>
  </main>

  <!-- ==== Core State ==== -->
  <script>
    window.questions = Array.isArray(window.questions) ? window.questions : [];
    window.dataReady = (typeof window.dataReady === 'boolean') ? window.dataReady : (window.questions.length > 0);
    window.selectedGrade = window.selectedGrade || 0;
    window.bank = Array.isArray(window.bank) ? window.bank : [];
    window.order = Array.isArray(window.order) ? window.order : [];
    window.current = Number(window.current||0);
    window.answers = (typeof window.answers==='object' && window.answers) ? window.answers : {};
    window.choiceOrder = window.choiceOrder || {};
    window.TIME_LIMIT_MINUTES = window.TIME_LIMIT_MINUTES || {1:30,2:25,3:20,4:15};
  </script>

  <!-- ==== CSV Parsers ==== -->
  <script>
    function parseCSV(text){
      const rows=[]; let i=0, f=false, c='', s='';
      for(i=0;i<text.length;i++){
        c=text[i];
        if(c==='"'){ f=!f; s+=c; }
        else if(c===',' && !f){ rows.push(s); s=''; }
        else if((c==='
'||c==='
') && !f){ rows.push(s); s=''; rows.push('\n'); }
        else{ s+=c; }
      }
      rows.push(s);
      const lines=[]; let line=[];
      for(const cell of rows){
        if(cell==='\n'){ lines.push(line); line=[]; }
        else line.push(cell.replace(/^"|"$/g,'').replace(/""/g,'"'));
      }
      if(line.length) lines.push(line);
      return lines;
    }
    function rowsToQuestions(lines){
      if(!lines || !lines.length) return [];
      const header = lines[0].map(h=>h.trim());
      const idx = name => header.findIndex(h => h.toLowerCase()===name.toLowerCase() || h===name);
      const map = {
        grade: idx('grade')>-1?idx('grade'):idx('級'),
        q: idx('q')>-1?idx('q'):idx('問題'),
        a1: idx('choice1')>-1?idx('choice1'):idx('選択肢1'),
        a2: idx('choice2')>-1?idx('choice2'):idx('選択肢2'),
        a3: idx('choice3')>-1?idx('choice3'):idx('選択肢3'),
        a4: idx('choice4')>-1?idx('choice4'):idx('選択肢4'),
        ans: idx('answer')>-1?idx('answer'):idx('正解'),
        exp: idx('exp')>-1?idx('exp'):idx('解説'),
        tags: idx('tags')>-1?idx('tags'):idx('タグ')
      };
      const out=[];
      for(let r=1;r<lines.length;r++){
        const row = lines[r];
        if(!row || row.length===0) continue;
        const toN = v => { const n = Number(String(v||'').replace(/[^\d]/g,'')); return isNaN(n)?0:n; };
        const g = toN(map.grade!=null?row[map.grade]:4) || 4;
        const q = (map.q!=null?row[map.q]:'').trim();
        const ch = [map.a1,map.a2,map.a3,map.a4].map(i => (i!=null?row[i]:'').trim()).filter(Boolean);
        const ansIndex1 = toN(map.ans!=null?row[map.ans]:1) || 1;
        if(!q || ch.length<2) continue;
        out.push({ id:r, grade:g, q:q, choices:ch, answer:Math.max(0,Math.min(ch.length-1, ansIndex1-1)), exp:(map.exp!=null?row[map.exp]:'').trim(), tags:(map.tags!=null?row[map.tags]:'').trim() });
      }
      return out;
    }
  </script>

  <!-- ==== Autoload (UTF-8/SJIS) ==== -->
  <script>
    (function(){
      async function readAsString(resp){
        const buf = await resp.arrayBuffer();
        try{ return new TextDecoder('utf-8',{fatal:false}).decode(buf); }catch(_){}
        try{ return new TextDecoder('shift_jis',{fatal:false}).decode(buf); }catch(_){}
        return await resp.text();
      }
      async function autoload(){
        const tryFiles = ['questions.csv','question.csv'];
        let got = null;
        for(const name of tryFiles){
          try{
            const r = await fetch(name, {cache:'no-store'});
            if(r.ok){ got = await readAsString(r); break; }
          }catch(e){}
        }
        if(!got){
          console.warn('[autoload] CSV not found');
          const s=document.getElementById('csv-status'); if(s) s.textContent='CSV: 見つかりません';
          return;
        }
        try{
          const lines = parseCSV(got);
          const imported = rowsToQuestions(lines);
          if(Array.isArray(imported) && imported.length){
            window.questions = imported;
            window.dataReady = true;
            const s=document.getElementById('csv-status'); if(s) s.textContent = 'CSV: OK ('+imported.length+'問)';
            const b=document.getElementById('btn-start'); if(b){ b.disabled=false; b.removeAttribute('disabled'); }
            if(typeof recountByGrade==='function') recountByGrade();
            console.log('[autoload] CSV loaded (questions.csv):', imported.length, 'questions');
          }else{
            console.warn('[autoload] parsed 0 questions');
            const s=document.getElementById('csv-status'); if(s) s.textContent='CSV: 0問（列名/grade列を確認）';
          }
        }catch(err){
          console.warn('[autoload] parse error', err);
        }
      }
      document.addEventListener('DOMContentLoaded', autoload);
    })();
  </script>

  <!-- ==== Helpers / UI ==== -->
  <script>
    document.addEventListener('DOMContentLoaded', function(){
      // 級の選択
      document.querySelectorAll('.grade').forEach(function(el){
        el.addEventListener('click', function(){
          window.selectedGrade = Number(el.dataset.grade||0);
          document.querySelectorAll('.grade').forEach(x=>x.classList.remove('active'));
          el.classList.add('active');
          var startBtn = document.getElementById('btn-start');
          if(startBtn){ startBtn.disabled=false; startBtn.removeAttribute('disabled'); }
          var lab = document.getElementById('selected-grade-label');
          if(lab){ lab.textContent = '選択中: ' + window.selectedGrade + '級'; }
        });
      });
      // 開始ボタン
      var sbtn = document.getElementById('btn-start');
      if(sbtn && !sbtn._bound){
        sbtn._bound = true;
        sbtn.addEventListener('click', function(e){
          e.preventDefault();
          if(typeof window.start === 'function'){ window.start(); }
        });
      }
      // メニューへ戻る
      var btm = document.getElementById('btn-back-menu');
      if(btm){ btm.addEventListener('click', function(){ if(typeof backToMenu==='function') backToMenu(); }); }
      var btm2 = document.getElementById('btn-to-menu');
      if(btm2){ btm2.addEventListener('click', function(){ if(typeof backToMenu==='function') backToMenu(true); }); }
    });
  </script>

  <!-- ==== Core Quiz Logic (with Prev) ==== -->
  <script>
    function recountByGrade(){
      try{
        const c = {1:0,2:0,3:0,4:0};
        const qs = Array.isArray(window.questions) ? window.questions : [];
        qs.forEach(q=>{ const g = Number(q && q.grade); if(g>=1 && g<=4) c[g]++; });
        const ids = {1:'count-g1',2:'count-g2',3:'count-g3',4:'count-g4'};
        Object.keys(ids).forEach(k=>{ const el = document.getElementById(ids[k]); if(el) el.textContent = String(c[k]); });
        window.countsByGrade = c;
      }catch(e){ console.warn('recountByGrade safe guard:', e); }
    }

    function prepareBank(grade){
      const g = Number(grade||0);
      const qs = Array.isArray(window.questions) ? window.questions : [];
      window.bank = qs.filter(q => Number(q && q.grade) === g);
      window.order = window.bank.map((_,i)=>i);
      window.current = 0;
      window.answers = {};
      window.choiceOrder = {};
    }

    function start(){
      if(!Array.isArray(window.questions) || !window.questions.length){ alert('問題データを読み込み中です。'); return; }
      var g = Number(window.selectedGrade||0);
      if(!g){ alert('級を選んでください。'); return; }
      prepareBank(g);
      if(!window.bank.length){ window.bank = window.questions.slice(); window.order = window.bank.map((_,i)=>i); }
      document.getElementById('menu')?.classList.add('hidden');
      document.getElementById('intro')?.classList.remove('hidden');
      document.getElementById('quiz')?.classList.remove('hidden');
      renderCurrent();
    }

    function renderCurrent(){
      if(!Array.isArray(window.bank) || !window.bank.length) return;
      const qi = window.order[window.current];
      const q = window.bank[qi] || {};
      const qtext = document.getElementById('qtext');
      const box = document.getElementById('choices');
      const nextBtn = document.getElementById('btn-next');
      if(qtext){ qtext.innerHTML = '<strong>Q.</strong> ' + (q.q || ''); }
      if(box){ box.innerHTML = ''; }
      if(nextBtn){ nextBtn.disabled = true; }
      (q.choices||[]).forEach((c,idx)=>{
        const b = document.createElement('button');
        b.className='choice'; b.type='button'; b.textContent=(idx+1)+'. '+c;
        b.addEventListener('click', ()=>{
          window.answers[qi]=idx;
          try{ box.querySelectorAll('.choice').forEach(x=>x.classList.remove('selected')); }catch(_){}
          b.classList.add('selected');
          if(nextBtn){ nextBtn.disabled=false; }
        });
        if(box) box.appendChild(b);
      });
      const pr = document.getElementById('progress');
      if(pr){ pr.textContent = String((window.current+1)+' / '+window.order.length); }
      const prevBtn = document.getElementById('btn-prev');
      if (prevBtn) { prevBtn.disabled = (window.current === 0); }
    }

    document.addEventListener('DOMContentLoaded', function(){
      const nb = document.getElementById('btn-next');
      if(nb){
        nb.addEventListener('click', function(){
          if(!Array.isArray(window.bank) || !window.bank.length) return;
          const qi = window.order[window.current];
          if(window.answers[qi]==null){ alert('選択肢を選んでください。'); return; }
          if(window.current < window.order.length-1){
            window.current++;
            renderCurrent();
          }else{
            finish();
          }
        });
      }
      const pb = document.getElementById('btn-prev');
      if (pb && !pb._bound) {
        pb._bound = true;
        pb.addEventListener('click', () => {
          if (window.current > 0) {
            window.current--;
            renderCurrent();
          }
        });
      }
    });

    function finish(){
      let correct = 0;
      (window.order||[]).forEach(qi=>{
        const q = (window.bank||[])[qi] || {};
        if(window.answers && window.answers[qi]===q.answer) correct++;
      });
      const el = document.getElementById('score');
      if(el){ el.textContent = 'スコア：' + correct + ' / ' + (window.order?window.order.length:0); }
      document.getElementById('quiz')?.classList.add('hidden');
      document.getElementById('summary')?.classList.remove('hidden');
    }

    function backToMenu(skipConfirm){
      if(!skipConfirm){
        if(!confirm('試験を中断してメニューに戻ります。進捗は失われます。よろしいですか？')) return;
      }
      window.answers = {}; window.current = 0; window.choiceOrder = {};
      try{
        document.getElementById('menu')?.classList.remove('hidden');
        document.getElementById('intro')?.classList.add('hidden');
        document.getElementById('quiz')?.classList.add('hidden');
        document.getElementById('summary')?.classList.add('hidden');
      }catch(e){}
      try{ if(typeof recountByGrade==='function') recountByGrade(); }catch(e){}
    }
  </script>
</body>
</html>
