
<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>あなたの検定</title>
  <style>
    :root{--gap:16px;--radius:16px}
    body{font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans JP", "Apple Color Emoji", "Segoe UI Emoji"; margin:0; background:#f7f7fb; color:#222}
    .wrap{max-width:980px; margin:0 auto; padding:24px}
    header{display:flex; gap:var(--gap); align-items:center; justify-content:space-between}
    h1{font-size:1.6rem; margin:.5rem 0}
    .card{background:#fff; border-radius:var(--radius); box-shadow:0 10px 25px rgba(0,0,0,.05); padding:20px; margin:20px 0}
    .muted{color:#666; font-size:.95rem}
    .row{display:flex; gap:var(--gap); align-items:center; flex-wrap:wrap}
    .btn{appearance:none; border:0; background:#222; color:#fff; padding:12px 16px; border-radius:12px; cursor:pointer; font-weight:600}
    .btn.secondary{background:#e9e9ef; color:#222}
    .btn.ghost{background:transparent; border:2px solid #ddd; color:#222}
    .btn:disabled{opacity:.5; cursor:not-allowed}
    .choices{display:grid; grid-template-columns:1fr; gap:10px; margin-top:12px}
    .choice{border:2px solid #e6e6ee; border-radius:12px; padding:12px; background:#fafafd; cursor:pointer}
    .choice[aria-checked="true"]{border-color:#222; background:#eef2ff}
    progress{width:100%; height:14px}
    .footer{display:flex; justify-content:space-between; gap:var(--gap); align-items:center; margin-top:12px}
    .badge{background:#eef2ff; color:#223; padding:6px 10px; border-radius:999px; font-weight:600}
    .result{font-size:1.2rem}
    .small{font-size:.9rem}
    .hidden{display:none}
    .qtext{font-size:1.1rem; font-weight:600}
    .qimg{margin-top:12px; display:grid; gap:12px;}
    .qimg img{max-width:100%; height:auto; border-radius:12px; box-shadow:0 6px 16px rgba(0,0,0,.06);}
    .grid2{display:grid; grid-template-columns:1.2fr .8fr; gap:var(--gap)}
    @media (max-width:780px){.grid2{grid-template-columns:1fr}}

    /* スタートメニュー */
    .grid4{display:grid; grid-template-columns:repeat(4, 1fr); gap:var(--gap)}
    @media (max-width:780px){.grid4{grid-template-columns:1fr 1fr}}
    .grade{border:2px solid #e6e6ee; border-radius:16px; padding:16px; background:#fff; cursor:pointer; transition:transform .06s ease}
    .grade:hover{transform:translateY(-2px)}
    .grade[data-active="true"]{border-color:#222; box-shadow:0 6px 16px rgba(0,0,0,.06)}
    .grade h3{margin:.2rem 0}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
    <div class="container row">
      <div><strong>検定サイト</strong> <span class="muted">（総問題数: <span id="total-count">0</span>）</span></div>
      <div class="muted">CSV は index.html と同じ階層に置いてください（questions.csv / question.csv）</div>
    </div>
  </header>

    <!-- スタートメニュー（級の選択） -->
    <section class="card" id="menu">
      <h2>級を選んでスタート</h2>
      <p class="small muted">「1級（最難）〜4級（入門）」。選んだ級の問題だけが出題されます。</p>
      <div class="grid4" id="grade-list">
        <div class="grade" data-grade="1">
          <span class="badge">1級</span>
          <h3>エキスパート</h3>
          <div class="small muted">応用・難問中心</div>
        </div>
        <div class="grade" data-grade="2">
          <span class="badge">2級</span>
          <h3>上級</h3>
          <div class="small muted">標準＋やや難</div>
        </div>
        <div class="grade" data-grade="3">
          <span class="badge">3級</span>
          <h3>中級</h3>
          <div class="small muted">基礎の確認</div>
        </div>
        <div class="grade" data-grade="4">
          <span class="badge">4級</span>
          <h3>入門</h3>
          <div class="small muted">初めての方に</div>
        </div>
      </div>
      <div class="row" style="margin-top:16px">
  <button class="btn" id="btn-start">この級で受験を開始</button>
<!-- ▼ 追加：CSVインポート -->
  </div>
    <p class="muted" id="selected-grade-label" style="margin-top:8px;"></p>
</section>

    <!-- 試験中のインジケータ -->
    <section class="card hidden" id="intro">
      <div class="grid2">
        <div>
          <p>選択中: <strong id="grade-label">—級</strong> ／ 全<span id="total-count">0</span>問・制限時間 <span id="limit-min">—</span> 分。</p>
          <p class="small muted">Tips: <mark>questions</mark> の <code>grade</code> を 1〜4 に設定してください。</p>
        </div>
        <div>
          <div class="card" style="margin:0">
            <div class="row" style="justify-content:space-between">
              <span class="badge">進捗</span>
              <span class="muted small"><span id="progress-label">0</span>%</span>
            </div>
            <progress id="progress" max="100" value="0"></progress>
            <div class="footer small muted"><span>残り時間: <strong id="time-left">--:--</strong></span><span>現在: <span id="pos">0</span>/<span id="total">0</span></span></div>
          </div>
        </div>
      </div>
    </section>

    <section id="quiz" class="card hidden">
  <div id="hud" class="hud">
    <span id="hud-time" class="badge">経過: 00:00</span>
    <span id="hud-remaining" class="badge">残り: 0問</span>
  </div>

      <div style="display:flex;justify-content:flex-end;gap:8px;margin-bottom:8px;">
        <button class="btn" id="btn-back-menu" type="button">メニューに戻る</button>
      </div>
      <div id="qtext"><strong>Q.</strong> …</div>
      <div class="choices" id="choices"></div>
      <div style="margin-top:12px; display:flex; gap:8px; align-items:center;">
        <button class="btn" id="btn-next" type="button">次へ</button>
        <span class="muted" id="progress">0 / 0</span>
      </div>
    </section>

    <section class="card hidden" id="summary">
      <h2>結果</h2>
      <p class="result">級: <strong id="result-grade"></strong> ／ スコア: <strong id="score"></strong> / <span id="score-total"></span>（正答率 <strong id="percent"></strong>%）</p>
      <div id="review"></div>
      <div class="row">
        <button class="btn" id="btn-retry">メニューへ戻る</button>
        <button class="btn secondary" id="btn-save">結果をCSVで保存</button>
      </div>
    </section>
  </div>

  
<script>
window.questions = window.questions || [];
let dataReady = false;
let selectedGrade = 0;
let bank = [];
let order = [];
let current = 0;
let answers = {};
let choiceOrder = {};
let startedAt = null;
let countdownId = null;
</script>

<!-- ==== CSV Parsers ==== -->
<script>
(function(){
  if (window._csvParsersReady) return; window._csvParsersReady = true;

  window.parseCSV = function(str){
    const out=[]; let row=[], cur='', q=false;
    for(let i=0;i<str.length;i++){
      const ch=str[i], nx=str[i+1];
      if(q){
        if(ch=='"' && nx=='"'){ cur+='"'; i++; }
        else if(ch=='"'){ q=false; }
        else { cur+=ch; }
      }else{
        if(ch=='"'){ q=true; }
        else if(ch==','){ row.push(cur); cur=''; }
        else if(ch=='\n'){ row.push(cur); out.push(row); row=[]; cur=''; }
        else if(ch=='\r'){ }
        else { cur+=ch; }
      }
    }
    row.push(cur); out.push(row);
    return out.filter(r=>r.some(c=>String(c).trim()!==''));
  };

  window.rowsToQuestions = function(rows){
    if(!rows.length) return [];
    const header = rows[0].map(h=>String(h||'').trim());
    const norm = s => String(s||'').toLowerCase().replace(/\s+/g,'').replace(/　/g,'');
    const findAny = cands => header.findIndex(h => cands.some(k => norm(h).includes(k)));
    const col = {
      id:     findAny(['id','識別','番号']),
      grade:  findAny(['grade','級','レベル','level','等級']),
      q:      findAny(['q','question','問題','設問','問']),
      c1:     findAny(['choice1','選択肢1','こたえ1','解答1','a)']),
      c2:     findAny(['choice2','選択肢2','こたえ2','解答2','b)']),
      c3:     findAny(['choice3','選択肢3','こたえ3','解答3','c)']),
      c4:     findAny(['choice4','選択肢4','こたえ4','解答4','d)']),
      c5:     findAny(['choice5','選択肢5','こたえ5','解答5','e)']),
      c6:     findAny(['choice6','選択肢6','こたえ6','解答6','f)']),
      answer: findAny(['answer','正解','解答','ans']),
      exp:    findAny(['exp','解説','説明','comment']),
      tags:   findAny(['tags','タグ','分類','カテゴリ']),
      img:    findAny(['img','画像','image']),
      images: findAny(['images','画像一覧'])
    };
    const hasHeader = col.q !== -1 && (col.c1 !== -1 || col.c2 !== -1);
    const start = hasHeader ? 1 : 0;
    const toHalf = s => String(s||'').replace(/[０-９]/g, d => String.fromCharCode(d.charCodeAt(0)-0xFEE0));
    const list = [];
    for(let r=start; r<rows.length; r++){
      const row = rows[r];
      const get = i => (i>=0 && i<row.length) ? String(row[i]||'').trim() : '';
      const q = get(col.q); if(!q) continue;
      const choices = [get(col.c1),get(col.c2),get(col.c3),get(col.c4),get(col.c5),get(col.c6)].filter(Boolean);
      if(choices.length<2) continue;
      let ansRaw = toHalf(get(col.answer)||'1'); const ansDig = ansRaw.match(/\d+/);
      const answer = ansDig ? Math.max(0, parseInt(ansDig[0],10)-1) : 0;
      let gRaw = toHalf(get(col.grade)||'4'); const gDig = gRaw.match(/[1-4]/);
      const grade = gDig ? parseInt(gDig[0],10) : 4;
      const exp = get(col.exp);
      const tags = (get(col.tags)||'').replace('／','/').replace('|','/').split('/').map(s=>s.trim()).filter(Boolean);
      const imgsField = get(col.images);
      const imgField = get(col.img);
      const images = imgsField ? imgsField.split('|').map(s=>s.trim()).filter(Boolean) : (imgField ? [imgField] : []);
      list.push({ id: get(col.id)||`q${r}`, grade, q, choices, answer, exp, tags, images });
    }
    return list;
  };
})();
</script>

<script>
(function(){
  if (window._csvParsersReady) return; window._csvParsersReady = true;

  window.parseCSV = function(str){
    const out=[]; let row=[], cur='', q=false;
    for(let i=0;i<str.length;i++){
      const ch=str[i], nx=str[i+1];
      if(q){
        if(ch=='"' && nx=='"'){ cur+='"'; i++; }
        else if(ch=='"'){ q=false; }
        else { cur+=ch; }
      }else{
        if(ch=='"'){ q=true; }
        else if(ch==','){ row.push(cur); cur=''; }
        else if(ch=='\n'){ row.push(cur); out.push(row); row=[]; cur=''; }
        else if(ch=='\r'){ }
        else { cur+=ch; }
      }
    }
    row.push(cur); out.push(row);
    return out.filter(r=>r.some(c=>String(c).trim()!==''));
  };

  window.rowsToQuestions = function(rows){
    if(!rows.length) return [];
    const header = rows[0].map(h=>String(h||'').trim());
    const norm = s => String(s||'').toLowerCase().replace(/\s+/g,'').replace(/　/g,'');
    const findAny = cands => header.findIndex(h => cands.some(k => norm(h).includes(k)));
    const col = {
      id:     findAny(['id','識別','番号']),
      grade:  findAny(['grade','級','レベル','level','等級']),
      q:      findAny(['q','question','問題','設問','問']),
      c1:     findAny(['choice1','選択肢1','こたえ1','解答1','a)']),
      c2:     findAny(['choice2','選択肢2','こたえ2','解答2','b)']),
      c3:     findAny(['choice3','選択肢3','こたえ3','解答3','c)']),
      c4:     findAny(['choice4','選択肢4','こたえ4','解答4','d)']),
      c5:     findAny(['choice5','選択肢5','こたえ5','解答5','e)']),
      c6:     findAny(['choice6','選択肢6','こたえ6','解答6','f)']),
      answer: findAny(['answer','正解','解答','ans']),
      exp:    findAny(['exp','解説','説明','comment']),
      tags:   findAny(['tags','タグ','分類','カテゴリ']),
      img:    findAny(['img','画像','image']),
      images: findAny(['images','画像一覧'])
    };
    const hasHeader = col.q !== -1 && (col.c1 !== -1 || col.c2 !== -1);
    const start = hasHeader ? 1 : 0;
    const toHalf = s => String(s||'').replace(/[０-９]/g, d => String.fromCharCode(d.charCodeAt(0)-0xFEE0));
    const list = [];
    for(let r=start; r<rows.length; r++){
      const row = rows[r];
      const get = i => (i>=0 && i<row.length) ? String(row[i]||'').trim() : '';
      const q = get(col.q); if(!q) continue;
      const choices = [get(col.c1),get(col.c2),get(col.c3),get(col.c4),get(col.c5),get(col.c6)].filter(Boolean);
      if(choices.length<2) continue;
      let ansRaw = toHalf(get(col.answer)||'1'); const ansDig = ansRaw.match(/\d+/);
      const answer = ansDig ? Math.max(0, parseInt(ansDig[0],10)-1) : 0;
      let gRaw = toHalf(get(col.grade)||'4'); const gDig = gRaw.match(/[1-4]/);
      const grade = gDig ? parseInt(gDig[0],10) : 4;
      const exp = get(col.exp);
      const tags = (get(col.tags)||'').replace('／','/').replace('|','/').split('/').map(s=>s.trim()).filter(Boolean);
      const imgsField = get(col.images);
      const imgField = get(col.img);
      const images = imgsField ? imgsField.split('|').map(s=>s.trim()).filter(Boolean) : (imgField ? [imgField] : []);
      list.push({ id: get(col.id)||`q${r}`, grade, q, choices, answer, exp, tags, images });
    }
    return list;
  };
})();
</script>

<!-- ==== Autoload (UTF-8/SJIS) ==== -->
<script>
(function(){
  if (window._csvAutoloadInstalled) return; window._csvAutoloadInstalled = true;
  function stripBOM(s){ return s && s.charCodeAt(0)===0xFEFF ? s.slice(1) : s; }
  function decodeWithFallback(buf){
    try{ const u = new TextDecoder('utf-8',{fatal:false}).decode(buf); if(u && u.indexOf('\uFFFD')===-1) return u; }catch(e){}
    try{ return new TextDecoder('shift_jis',{fatal:false}).decode(buf); }catch(e){}
    try{ return new TextDecoder('utf-8').decode(buf); }catch(e){ return ''; }
  }
  async function fetchCsvTry(files){
    for(const f of files){
      try{
        const res = await fetch(f + '?v=' + Date.now(), {cache:'no-store'});
        if(res.ok){
          const buf = await res.arrayBuffer();
          const txt = decodeWithFallback(buf);
          if (txt && txt.trim()) return {name:f, text:txt};
        }
      }catch(e){ console.warn('fetch failed', f, e); }
    }
    return null;
  }
  async function autoload(){
    const got = await fetchCsvTry(['questions.csv','question.csv']);
    if(!got){ console.warn('[autoload] CSV not found'); return; }
    let csv = stripBOM(got.text).replace(/\r\n/g,'\n').replace(/\r/g,'\n');
    if (typeof parseCSV !== 'function' || typeof rowsToQuestions !== 'function'){ console.error('[autoload] parsers missing'); return; }
    try{
      const rows = parseCSV(csv);
      const imported = rowsToQuestions(rows);
      if(Array.isArray(imported) && imported.length){
        window.questions = Array.isArray(window.questions)?window.questions:[];
        window.questions.splice(0, window.questions.length, ...imported);
        dataReady = true;
        const el = document.getElementById('total-count'); if(el) el.textContent = String(imported.length);
        recountByGrade();
        console.log(`[autoload] CSV loaded (${got.name}): ${imported.length} questions`);
      }else{
        console.warn('[autoload] parsed 0 questions');
      }
    }catch(e){ console.error('[autoload] parse error', e); }
  }
  if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', autoload); } else { autoload(); }
})();
</script>

<script>
(function(){
  if (window._csvAutoloadInstalled) return; window._csvAutoloadInstalled = true;
  function stripBOM(s){ return s && s.charCodeAt(0)===0xFEFF ? s.slice(1) : s; }
  function decodeWithFallback(buf){
    try{ const u = new TextDecoder('utf-8',{fatal:false}).decode(buf); if(u && u.indexOf('\uFFFD')===-1) return u; }catch(e){}
    try{ return new TextDecoder('shift_jis',{fatal:false}).decode(buf); }catch(e){}
    try{ return new TextDecoder('utf-8').decode(buf); }catch(e){ return ''; }
  }
  async function fetchCsvTry(files){
    for(const f of files){
      try{
        const res = await fetch(f + '?v=' + Date.now(), {cache:'no-store'});
        if(res.ok){
          const buf = await res.arrayBuffer();
          const txt = decodeWithFallback(buf);
          if (txt && txt.trim()) return {name:f, text:txt};
        }
      }catch(e){ console.warn('fetch failed', f, e); }
    }
    return null;
  }
  async function autoload(){
    const got = await fetchCsvTry(['questions.csv','question.csv']);
    if(!got){ console.warn('[autoload] CSV not found'); return; }
    let csv = stripBOM(got.text).replace(/\r\n/g,'\n').replace(/\r/g,'\n');
    if (typeof parseCSV !== 'function' || typeof rowsToQuestions !== 'function'){ console.error('[autoload] parsers missing'); return; }
    try{
      const rows = parseCSV(csv);
      const imported = rowsToQuestions(rows);
      if(Array.isArray(imported) && imported.length){
        window.questions = Array.isArray(window.questions)?window.questions:[];
        window.questions.splice(0, window.questions.length, ...imported);
        dataReady = true;
        const el = document.getElementById('total-count'); if(el) el.textContent = String(imported.length);
        recountByGrade();
        console.log(`[autoload] CSV loaded (${got.name}): ${imported.length} questions`);
      }else{
        console.warn('[autoload] parsed 0 questions');
      }
    }catch(e){ console.error('[autoload] parse error', e); }
  }
  if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', autoload); } else { autoload(); }
})();
</script>

<!-- ==== Helpers / UI ==== -->
<script>
function recountByGrade(){
  const c = {1:0,2:0,3:0,4:0};
  (Array.isArray(window.questions)?window.questions:[]).forEach(q=>{
    const g = Number(q && q.grade);
    if(g>=1 && g<=4) c[g]++;
  });
  document.getElementById('count-g1').textContent = c[1];
  document.getElementById('count-g2').textContent = c[2];
  document.getElementById('count-g3').textContent = c[3];
  document.getElementById('count-g4').textContent = c[4];
  window.countsByGrade = c;
}

document.addEventListener('DOMContentLoaded', function(){
  // grade select numeric
  document.querySelectorAll('.grade').forEach(function(el){
    el.addEventListener('click', function(){
      selectedGrade = Number(el.dataset.grade||0);
      document.querySelectorAll('.grade').forEach(x=>x.classList.remove('active'));
      el.classList.add('active');
      // enable start
      if(startBtn){ startBtn.disabled = false; startBtn.removeAttribute('disabled'); }
      // label
      var lab = document.getElementById('selected-grade-label');
      if(lab){ lab.textContent = '選択中: ' + selectedGrade + '級'; }
    });
  });

  // start button
  var startBtn = document.getElementById('btn-start');
  if(startBtn){
    startBtn.disabled = false;
    startBtn.removeAttribute('disabled');
    startBtn.addEventListener('click', function(e){
      e.preventDefault();
      start();
    });
  }

  // next
  document.getElementById('btn-next').addEventListener('click', function(){
    if(current < order.length-1){
      current++;
      renderCurrent();
    }else{
      finish();
    }
  });

  // summary → menu
  document.getElementById('btn-retry').addEventListener('click', function(){
    backToMenu(true);
  });

  // back to menu in quiz
  document.getElementById('btn-back-menu').addEventListener('click', function(){
    backToMenu(false);
  });
});
</script>

</body>
</html>
